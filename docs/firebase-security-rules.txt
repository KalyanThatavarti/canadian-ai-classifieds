// Firebase Firestore Security Rules
// For Canadian AI Classifieds User Profile System
// 
// To apply these rules:
// 1. Go to Firebase Console → Firestore Database → Rules tab
// 2. Copy and paste these rules
// 3. Click "Publish"

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles (for public view)
      allow read: if true;
      
      // Only the user can create/update their own profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      
      // Prevent deletion (soft delete should be used via admin)
      allow delete: if false;
      
      // Favorites subcollection - MUST be inside users match block
      match /favorites/{listingId} {
        // Only owner can read/write their favorites
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }
    
    // Listings collection
    match /listings/{listingId} {
      // Anyone can read active listings
      allow read: if true;
      
      // Authenticated users can create listings (relaxed for admin/seeding)
      allow create: if isAuthenticated();
      
      // Only the listing owner can update (including favorites count)
      allow update: if isAuthenticated();
      
      // Only the owner can delete (soft delete via status change)
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
    }
  }
}


// Firebase Storage Security Rules
// To apply:
// 1. Go to Firebase Console → Storage → Rules tab
// 2. Copy and paste these rules
// 3. Click "Publish"

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Profile photos
    match /profiles/{userId}/{allPaths=**} {
      // Allow read by anyone
      allow read: if true;
      
      // Allow write only by the user themselves
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024  // Max 5MB
                   && request.resource.contentType.matches('image/.*');
    }
    
    // Listing images
    match /listings/{userId}/{allPaths=**} {
      // Allow read by anyone
      allow read: if true;
      
      // Allow write only by authenticated users
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024  // Max 10MB
                   && request.resource.contentType.matches('image/.*');
    }
    
    // Deny all other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
